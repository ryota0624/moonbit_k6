# test_on_k6 - k6 MoonBit Library Test Suite

ã“ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã¯ã€MoonBitã§å®Ÿè£…ã—ãŸk6ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®å‹•ä½œã‚’**å®Ÿéš›ã®k6ãƒ©ãƒ³ã‚¿ã‚¤ãƒ ä¸Šã§æ¤œè¨¼ã™ã‚‹**ãŸã‚ã®ãƒ†ã‚¹ãƒˆã‚¹ã‚¤ãƒ¼ãƒˆã§ã™ã€‚

## ç›®çš„

- MoonBitã§æ›¸ã„ãŸã‚·ãƒŠãƒªã‚ªãŒæ„å›³é€šã‚Šã«å‹•ä½œã™ã‚‹ã‹ã‚’ç¢ºèª
- k6ã®ãƒ¬ãƒãƒ¼ãƒˆå‡ºåŠ›ã‚’ä½¿ã£ã¦æœŸå¾…å€¤ã¨ã®æ•´åˆæ€§ã‚’æ¤œè¨¼
- `moon test`ã§ã¯ãªãã€å®Ÿéš›ã®k6ç’°å¢ƒã§å®Ÿè¡Œ

## ç‰¹å¾´

### âœ… æœŸå¾…å€¤é§†å‹•ã®ãƒ†ã‚¹ãƒˆè¨­è¨ˆ

å„ãƒ†ã‚¹ãƒˆã«ã¯ã€ŒæœŸå¾…ã•ã‚Œã‚‹å‹•ä½œã€ãŒã‚³ãƒ¡ãƒ³ãƒˆã§æ˜è¨˜ã•ã‚Œã¦ã„ã¾ã™ï¼š

```moonbit
// æœŸå¾…ã•ã‚Œã‚‹å‹•ä½œ:
// - VU: 1
// - Iterations: 3
// - http_reqs: 6 (2 requests per iteration)
// - checks: 9 (3 checks per iteration)
```

### âœ… k6ãƒ¬ãƒãƒ¼ãƒˆã§æ¤œè¨¼

ãƒ†ã‚¹ãƒˆå®Ÿè¡Œå¾Œã®k6ãƒ¬ãƒãƒ¼ãƒˆã§ã€æœŸå¾…å€¤ã¨å®Ÿéš›ã®å€¤ã‚’æ¯”è¼ƒã—ã¾ã™ï¼š

```
checks.........................: 100.00% âœ“ 9 âœ— 0
http_reqs......................: 6       X/s
test_counter...................: 3       X/s
```

## ã‚¯ã‚¤ãƒƒã‚¯ã‚¹ã‚¿ãƒ¼ãƒˆ

### ğŸš€ è‡ªå‹•æ¤œè¨¼ä»˜ãCIå®Ÿè¡Œï¼ˆæ¨å¥¨ï¼‰

```bash
npm run ci:verify
```

ã“ã®ã‚³ãƒãƒ³ãƒ‰ã¯ä»¥ä¸‹ã‚’è‡ªå‹•å®Ÿè¡Œï¼š
1. `npm run build` - ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰ã‚’ãƒ“ãƒ«ãƒ‰ï¼ˆMoonBit â†’ JSï¼‰
2. `npm run build:verify` - æ¤œè¨¼ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ãƒ“ãƒ«ãƒ‰ï¼ˆMoonBit â†’ JSï¼‰
3. `npm run test:json` - k6å®Ÿè¡Œ + summary.jsonç”Ÿæˆ
4. `npm run verify` - **æœŸå¾…å€¤ã¨ã®è‡ªå‹•æ¤œè¨¼** â† NEW!

**æœŸå¾…å€¤ã¨ä¸€è‡´ã—ãªã„å ´åˆã€exit code 1ã§çµ‚äº†ã—ã¾ã™ã€‚**

### ãƒ¯ãƒ³ã‚³ãƒãƒ³ãƒ‰ã§å…¨ãƒ†ã‚¹ãƒˆå®Ÿè¡Œï¼ˆè‡ªå‹•æ¤œè¨¼ãªã—ï¼‰

```bash
npm run ci
```

ã“ã®ã‚³ãƒãƒ³ãƒ‰ã¯ä»¥ä¸‹ã‚’å®Ÿè¡Œã—ã¾ã™ï¼š
1. `npm install` - ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
2. `npm run build` - MoonBit â†’ JSå¤‰æ›ï¼ˆviteï¼‰
3. `npm run test` - k6ã§ãƒ†ã‚¹ãƒˆå®Ÿè¡Œï¼ˆç›®è¦–ç¢ºèªï¼‰

### å€‹åˆ¥ã‚¹ãƒ†ãƒƒãƒ—ã§ã®å®Ÿè¡Œ

```bash
# 1. ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
npm install

# 2. ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰ã‚’ãƒ“ãƒ«ãƒ‰
npm run build

# 3. æ¤œè¨¼ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ãƒ“ãƒ«ãƒ‰
npm run build:verify

# 4. k6ã§ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ + JSONå‡ºåŠ›
npm run test:json

# 5. è‡ªå‹•æ¤œè¨¼
npm run verify
# â†’ âœ… All expectations passed! ã¾ãŸã¯ âŒ ã‚¨ãƒ©ãƒ¼è¡¨ç¤º
```

## ğŸ¤– è‡ªå‹•æ¤œè¨¼æ©Ÿèƒ½

test_on_k6ã¯ã€k6ã®å®Ÿè¡Œçµæœã‚’è‡ªå‹•çš„ã«æ¤œè¨¼ã™ã‚‹æ©Ÿèƒ½ã‚’å‚™ãˆã¦ã„ã¾ã™ã€‚

### ä»•çµ„ã¿

1. **æœŸå¾…å€¤ã®å®šç¾©** (`expectations.json`)
   ```json
   {
     "testName": "k6 MoonBit Library Test",
     "expectations": [
       {
         "metric": "http_reqs",
         "path": "metrics.http_reqs.count",
         "expected": 6,
         "type_": "exact"
       }
     ]
   }
   ```

2. **k6å®Ÿè¡Œã¨JSONå‡ºåŠ›**
   ```bash
   k6 run --summary-export=summary.json dist/test.js
   ```

3. **MoonBitæ¤œè¨¼ã‚¹ã‚¯ãƒªãƒ—ãƒˆå®Ÿè¡Œ**
   ```bash
   node verify/_build/js/release/build/k6-verify.js
   ```

   - `summary.json`ã‚’èª­ã¿è¾¼ã¿
   - `expectations.json`ã¨æ¯”è¼ƒ
   - ä¸€è‡´: exit 0
   - ä¸ä¸€è‡´: exit 1 + ã‚¨ãƒ©ãƒ¼è©³ç´°

### æ¤œè¨¼ã‚¿ã‚¤ãƒ—

- `exact`: å®Œå…¨ä¸€è‡´
- `min`: æœ€å°å€¤ä»¥ä¸Š
- `max`: æœ€å¤§å€¤ä»¥ä¸‹

### å‡ºåŠ›ä¾‹

**æˆåŠŸæ™‚:**
```
âœ“ iterations: 3 (expected: 3)
âœ“ http_reqs: 6 (expected: 6)
âœ“ checks_value: 1 (expected: 1)
âœ… All expectations passed!
```

**å¤±æ•—æ™‚:**
```
âœ— http_reqs: 5 (expected: 6)
âŒ 1 expectation(s) failed:
  - http_reqs:
      Expected: 6
      Actual:   5
```

## ãƒ†ã‚¹ãƒˆå†…å®¹

`src/test_all.mbt` ã«å…¨ã¦ã®ãƒ†ã‚¹ãƒˆãŒå«ã¾ã‚Œã¦ã„ã¾ã™ï¼š

### 1. Core API Tests
- `group()` - ã‚°ãƒ«ãƒ¼ãƒ—åŒ–æ©Ÿèƒ½
- `check()` - ãƒ¬ã‚¹ãƒãƒ³ã‚¹æ¤œè¨¼
- `sleep()` - å¾…æ©Ÿæ©Ÿèƒ½

### 2. HTTP Tests
- `quick_get()` - HTTPãƒªã‚¯ã‚¨ã‚¹ãƒˆ
- `check_all()` - è¤‡æ•°ã®check
- ãƒ¬ã‚¹ãƒãƒ³ã‚¹å‡¦ç†

### 3. Metrics Tests
- `Counter` - ã‚«ã‚¦ãƒ³ã‚¿ãƒ¡ãƒˆãƒªã‚¯ã‚¹
- ã‚«ã‚¹ã‚¿ãƒ ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã®è¨˜éŒ²

### 4. Lifecycle Tests
- `on_first_iteration()` - åˆå›ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
- `every_n_iterations()` - Nå›ã”ã¨ã®å®Ÿè¡Œ

## k6ãƒ¬ãƒãƒ¼ãƒˆã®èª­ã¿æ–¹

### ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã®ç¢ºèªé …ç›®

| ãƒ¡ãƒˆãƒªã‚¯ã‚¹ | èª¬æ˜ | æœŸå¾…å€¤ã®ä¾‹ |
|-----------|------|-----------|
| `iterations` | å®Ÿè¡Œã•ã‚ŒãŸã‚¤ãƒ†ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³æ•° | `3` |
| `http_reqs` | HTTPãƒªã‚¯ã‚¨ã‚¹ãƒˆç·æ•° | `6` |
| `checks` | checkæˆåŠŸç‡ | `100% âœ“ 9 âœ— 0` |
| `test_counter` | ã‚«ã‚¹ã‚¿ãƒ ã‚«ã‚¦ãƒ³ã‚¿ï¼ˆä¾‹ï¼‰ | `3` |
| `http_req_failed` | HTTPãƒªã‚¯ã‚¨ã‚¹ãƒˆå¤±æ•—ç‡ | `0%` |

### æˆåŠŸåˆ¤å®š

ãƒ†ã‚¹ãƒˆãŒæ„å›³é€šã‚Šã«å‹•ä½œã—ã¦ã„ã‚‹å ´åˆï¼š
- âœ… `checks`: 100% (å…¨ã¦æˆåŠŸ)
- âœ… `http_req_failed`: 0%
- âœ… å„ãƒ¡ãƒˆãƒªã‚¯ã‚¹ãŒæœŸå¾…å€¤ã¨ä¸€è‡´

## ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆ

```
test_on_k6/
â”œâ”€â”€ package.json           # npmè¨­å®šã€ã‚¹ã‚¯ãƒªãƒ—ãƒˆå®šç¾©
â”œâ”€â”€ vite.config.js         # viteãƒ“ãƒ«ãƒ‰è¨­å®š
â”œâ”€â”€ moon.mod.json          # MoonBitãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«è¨­å®š
â”œâ”€â”€ index.js               # ã‚¨ãƒ³ãƒˆãƒªãƒã‚¤ãƒ³ãƒˆ
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ moon.pkg           # ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸è¨­å®š
â”‚   â””â”€â”€ test_all.mbt       # å…¨ãƒ†ã‚¹ãƒˆã‚¹ã‚¤ãƒ¼ãƒˆ
â”œâ”€â”€ verify/                # â† NEW: æ¤œè¨¼ã‚¹ã‚¯ãƒªãƒ—ãƒˆï¼ˆMoonBitå®Ÿè£…ï¼‰
â”‚   â”œâ”€â”€ moon.mod.json
â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”œâ”€â”€ moon.pkg
â”‚   â”‚   â””â”€â”€ main.mbt       # æ¤œè¨¼ãƒ­ã‚¸ãƒƒã‚¯
â”‚   â””â”€â”€ _build/            # ãƒ“ãƒ«ãƒ‰æˆæœç‰©
â”œâ”€â”€ expectations.json      # â† NEW: æœŸå¾…å€¤å®šç¾©
â”œâ”€â”€ summary.json           # k6ãŒç”Ÿæˆï¼ˆè‡ªå‹•ç”Ÿæˆï¼‰
â”œâ”€â”€ dist/                  # ãƒ“ãƒ«ãƒ‰æˆæœç‰©ï¼ˆè‡ªå‹•ç”Ÿæˆï¼‰
â”‚   â””â”€â”€ test.js
â””â”€â”€ README.md              # ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«
```

## é–‹ç™ºãƒ•ãƒ­ãƒ¼

### æ–°ã—ã„ãƒ†ã‚¹ãƒˆã®è¿½åŠ 

1. `src/test_all.mbt` ã‚’ç·¨é›†
2. æœŸå¾…å€¤ã‚’ã‚³ãƒ¡ãƒ³ãƒˆã§æ˜è¨˜
3. ãƒ“ãƒ«ãƒ‰ãƒ»å®Ÿè¡Œ
4. k6ãƒ¬ãƒãƒ¼ãƒˆã§æ¤œè¨¼

```moonbit
@k6.group("New Test", fn() {
  // æœŸå¾…: http_reqs += 1
  let res = @k6.quick_get("https://httpbin.org/get")

  // æœŸå¾…: checkæˆåŠŸ
  let _check = @k6.check_status_ok(res)
})
```

### ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

**ãƒ“ãƒ«ãƒ‰ã‚¨ãƒ©ãƒ¼ãŒå‡ºã‚‹å ´åˆ:**
```bash
# MoonBitä¾å­˜é–¢ä¿‚ã®æ›´æ–°
moon install
moon build --target js
```

**k6ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆ:**
```bash
# k6ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
# macOS:
brew install k6

# ãã®ä»–:
https://k6.io/docs/getting-started/installation/
```

## CI/CDçµ±åˆ

GitHub Actionsã‚„GitLab CIã§ä½¿ç”¨ã™ã‚‹å ´åˆï¼š

```yaml
# .github/workflows/test.yml
- name: Run k6 tests
  run: |
    cd test_on_k6
    npm run ci
```

## example-vite ã¨ã®é•ã„

| | test_on_k6 | example-vite |
|---|-----------|--------------|
| **ç›®çš„** | ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®æ©Ÿèƒ½æ¤œè¨¼ | ãƒ¦ãƒ¼ã‚¶ãƒ¼å‘ã‘ã‚µãƒ³ãƒ—ãƒ« |
| **å¯¾è±¡** | é–‹ç™ºè€… | ãƒ¦ãƒ¼ã‚¶ãƒ¼ |
| **å†…å®¹** | æ©Ÿèƒ½ç¶²ç¾…çš„ãªãƒ†ã‚¹ãƒˆ | å®Ÿç”¨çš„ãªã‚·ãƒŠãƒªã‚ªä¾‹ |
| **å®Ÿè¡Œ** | CI/CDè‡ªå‹•ãƒ†ã‚¹ãƒˆ | ãƒãƒ‹ãƒ¥ã‚¢ãƒ«å®Ÿè¡Œã€å­¦ç¿’ç”¨ |
| **VUæ•°** | 1 | 2ã€œ10 |
| **æœŸé–“** | çŸ­æ™‚é–“ï¼ˆæ•°ç§’ï¼‰ | é•·æ™‚é–“ï¼ˆ20ç§’ã€œï¼‰ |

## å‚è€ƒè³‡æ–™

- [k6 Documentation](https://k6.io/docs/)
- [k6 Metrics](https://grafana.com/docs/k6/latest/using-k6/metrics/)
- [MoonBit](https://www.moonbitlang.com/)
- ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ«ãƒ¼ãƒˆã®APIå®Ÿè£…ï¼ˆ`../k6.mbt`, `../http.mbt` ãªã©ï¼‰
